# 单片机调试找错

- 单片机开发，不仅涉及软件开发，还需要硬件调试。两者纠缠，常常出错。

- 导致现象可能和预期不一样。

- 导致同一个现象，往往对应很多不同的结果，所以要排查。

- 排查大体上从硬件到软件，从整体到局部，如果没有找到错误，则倒查，反复查找。

- 以单片机-红外模块-LED为例，红外检测则单片机输出高电平控制LED灯点亮，红外未检测则单片机控制电平低使得LED灭。

- 本内容默认读者拥有一定的简单基础，能完成烧录、编程等基础操作。

- 以控制变量法为主，不要主观相信任何没有实际测试的部分，不要过分相信队友。

不要发懒。

# 1. 问题复现

- 稳定复现问题才能正确的对问题进行定位、解决以及验证。
- 一般来说，越容易复现的问题越容易解决。

## 1.1 模拟复现条件

- 有的问题存在于特定的条件下，需要模拟出现问题的条件才可复现。

- 问题难以复现，可以提高相关任务执行频率，可以多套设备同时进行测试。

- 对于依赖外部输入的条件，如果条件比较复杂难以模拟可以考虑程序里预设直接进入对应状态。


# 2. 排查顺序

## 2.1 硬件

- 排除设计和加工的工艺错误。主要排除错误包括错线、开路和短路。仔细查看原理图。特别注意电源系统的检查，以防止电源短路和极性错误，并重点检查系统总线(地址总线、数据总线和控制总线)是否相互短路或与其他信号线短路。如有必要，使用数字万用表的短路测试功能可以缩短故障排除时间。

- 烧录单片机厂家的测试例程，或者以板载硬件LED为测试内容，以此确定单片机没问题。不要死脑筋，串口出错了一直试LED有没有错。

- 测试模块是否有问题。两个模块：红外检测模块和外接LED都测试，通过上电，保证其功能能正常完成，其正常完成以指示灯亮为标志。不要死脑筋，比如超声波模块一直得不到距离或者乱码，但是看了指示灯就说没问题。起码也应该接串口看看到底硬件是否出错。

- 元器件在购买时良好，但是烧坏也正常。所以之前功能正常，但是现在坏了，无法观察到现象。

- 杜邦线是否有问题。之前出过类似问题，因为瞬间大电流内部烧断，但是外貌看起来正常。

- 虚焊问题导致接触有问题，杜邦线接线松垮，导致接触有问题。如有必要，热熔胶粘住。

- 软件设置GPIO端口，是否与物理上的硬件接线口对应。

- 电压/电流不足，导致不能完成功能，电压够了不代表电流够，之前有过情况，摄像头供电电压足够，电流不够导致不断重启。

## 2.2 软件

- 报错导致不生成hex文件过于初级，不提及。

- 烧录单片机厂家的测试例程，或者以板载硬件LED为测试内容，以此确定单片机没问题。

- 对照完成可使用代码，对比查看自己代码。

- 对照用户手册，查看是否理解错误。

- 跳转结构体定义，对照结构体，查看是否缺少语句。

- 使用项目内的find功能，查看是否无意识压到键盘多了内容。比如无意去掉了注释，无意加了注释，添加了含义冲突内容等。

```c
无意去掉了注释，或者添加注释：
预期：上电LED就亮。
在main.c中，
main()
{
  //LED0=0；//置高
  LED0=1；//置低
}
```

```c
添加了含义冲突内容
预期：上电LED就亮。
在main.c中，
main()
{
  LED0=0；//置高
}
但是在led.c中，led_init()函数中，
void led_init(void)
{
  ...
  GPIO_ResetBits(GPIO_LED, GPIO_Pin_LED);  //置低
}
前后不同文件冲突。
```

- 使用手册，明确含义。比如有的厂家置0为高电平，有的厂家置1为高电平。
```c
LED1 = 1;  //A厂亮灯语句

LED1 = 0;  //B厂亮灯语句
```

- 去掉限制条件，直接查看内容。
```c
原本：
if(situation)
{
  funtion();
}

现在：
  funtion();
```

- 自上而下，使用led功能作为标志位，控制变量，每一句，每一个函数，函数开始，函数出口，函数结束，排查错误位置。

- 自上而下，使用USART功能作为标志位，控制变量，每一句，每一个函数，函数开始，函数出口，函数结束，排查错误位置。

- 自上而下，使用LOG功能，控制变量，每一句，每一个函数，函数开始，函数出口，函数结束，排查错误位置。

- 自上而下，使用OLED/LCD功能作为标志位，控制变量，每一句，每一个函数，函数开始，函数出口，函数结束，排查错误位置。

- 版本回退，不要告诉我你的文件每次更新之后不备份。使用旧版本查看是否能完成功能。确定是否是增加修改的代码出了问题。

- 具体常见错误：定时器回调函数内容过多停留时间过长导致跑飞，有if没有else导致代码跑飞，没有看门狗wdg导致不知道跑飞，通信没有对上导致跑飞。










